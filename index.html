<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieDrift</title>
<style>
:root{--bg:#000;--card-bg:#0a0a0a;--accent:#00ff66;--text:#ddd;--muted:#888}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;align-items:center;background:#111;padding:10px 20px;flex-wrap:wrap}
.logo{font-size:24px;font-weight:bold;color:var(--accent)}
.controls{display:flex;gap:10px;flex-wrap:wrap}
input,select,button,textarea{padding:6px 10px;border:1px solid var(--accent);border-radius:4px;background:var(--card-bg);color:var(--text)}
button{cursor:pointer;font-weight:bold}button:hover{background:#003300}
main{padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px}
.card{background:var(--card-bg);border:1px solid rgba(0,255,102,0.15);border-radius:8px;overflow:hidden;display:flex;flex-direction:column;transition:transform 0.2s}
.card:hover{transform:scale(1.05)}
.poster{width:100%;height:300px;object-fit:cover}
.card-body{padding:10px;flex-grow:1;display:flex;flex-direction:column;justify-content:space-between}
.movie-title{font-size:16px;font-weight:bold;color:var(--accent);margin:0}
.meta{font-size:13px;color:var(--muted);margin:4px 0}
.card-actions{display:flex;gap:5px;flex-wrap:wrap}
.btn{flex:1;text-align:center}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);justify-content:center;align-items:center;z-index:1000;overflow-y:auto}
.modal-content{background:var(--card-bg);max-width:900px;width:95%;max-height:90vh;overflow-y:auto;border-radius:8px;padding:20px;position:relative}
.close{position:absolute;top:10px;right:15px;cursor:pointer;color:var(--accent);font-size:22px}
iframe,video{width:100%;height:400px;border-radius:6px}
#adminPanel{display:none;padding:20px;background:var(--card-bg);border-top:1px solid rgba(0,255,102,0.15)}
#adminPanel h3{color:var(--accent);margin-bottom:10px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
label{font-size:13px;color:var(--muted);margin-bottom:3px;display:block}
.form-control{display:flex;flex-direction:column}
textarea{resize:vertical;min-height:80px}
.submit-row{margin-top:15px;text-align:right}
#watchlistModal h2{color:var(--accent);margin-bottom:15px}
#watchlistModal .movie-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px}
.watchlist-card{background:#111;border-radius:8px;padding:10px;text-align:center;transition:transform 0.2s}
.watchlist-card:hover{transform:scale(1.05);background:#181818}
.watchlist-card img{width:100%;border-radius:6px;margin-bottom:6px}
.remove-btn{margin-top:6px;padding:4px 8px;border:none;border-radius:4px;background:#e63946;color:white;cursor:pointer;font-size:0.8rem}
.remove-btn:hover{background:#c82333}
</style>
</head>
<body>
<header>
  <div class="logo">MovieDrift</div>
  <div class="controls">
    <input id="search" type="search" placeholder="Search movies...">
    <select id="genreFilter"><option value="">All genres</option></select>
    <select id="yearFilter"><option value="">All years</option></select>
    <button id="watchlistToggle">Watchlist (0)</button>
    <button id="adminLogin">Admin Login</button>
  </div>
</header>

<main><div id="grid" class="grid"></div></main>

<section id="adminPanel">
  <h3>âž• Add/Edit Movie</h3>
  <div class="form-grid">
    <div class="form-control"><label>Title</label><input id="movieTitle" type="text"></div>
    <div class="form-control"><label>Year</label><input id="movieYear" type="number"></div>
    <div class="form-control"><label>Genres (comma separated)</label><input id="movieGenres" type="text"></div>
    <div class="form-control"><label>Poster Image</label><input id="moviePosterFile" type="file" accept="image/*"></div>
    <div class="form-control"><label>Movie File (MP4)</label><input id="movieFile" type="file" accept="video/mp4"></div>
    <div class="form-control"><label>Trailer/Embed Link</label><input id="movieTrailer" type="url"></div>
    <div class="form-control"><label>Description</label><textarea id="movieDesc"></textarea></div>
    <div class="form-control"><label>Episode Title</label><input id="episodeTitle" type="text"></div>
    <div class="form-control"><label>Episode File</label><input id="episodeFile" type="file" accept="video/mp4"></div>
    <button id="addEpisodeBtn">Add Episode</button>
    <div id="episodeListAdmin"></div>
  </div>
  <div class="submit-row">
    <button id="addMovieBtn">Add Movie/Series</button>
    <button id="editMovieBtn" style="display:none;">Save Changes</button>
  </div>
  <h3>ðŸ“‹ Manage Movies</h3>
  <div id="adminMovieList"></div>
</section>

<div class="modal" id="watchlistModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('watchlistModal')">&times;</span>
    <h2>ðŸ“º Your Watchlist</h2>
    <div class="movie-list" id="watchlistContainer"></div>
  </div>
</div>

<script>
let movies = JSON.parse(localStorage.getItem("movies"))||[];
let watchlist = JSON.parse(localStorage.getItem("watchlist"))||[];
let editIndex = null;
let tempEpisodes = [];

const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");
const genreFilter = document.getElementById("genreFilter");
const yearFilter = document.getElementById("yearFilter");

// Upload helper
async function uploadFile(file,type){
  const fd = new FormData();
  fd.append("file",file);
  fd.append("type",type);
  const res = await fetch("upload.php",{method:"POST",body:fd});
  const data = await res.json();
  if(data.status==="success") return data.url;
  throw new Error(data.message);
}

// Render movies
function renderMovies(){
  grid.innerHTML="";
  const searchText = searchInput.value.toLowerCase();
  const genre = genreFilter.value;
  const year = yearFilter.value;
  const filtered = movies.filter(m=>{
    const s = m.title.toLowerCase().includes(searchText) || m.description.toLowerCase().includes(searchText);
    const g = genre?m.genres.includes(genre):true;
    const y = year?m.year==year:true;
    return s && g && y;
  });
  filtered.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <img class="poster" src="${m.poster}" alt="${m.title}">
      <div class="card-body">
        <h3 class="movie-title">${m.title}</h3>
        <div class="meta">${m.year} Â· ${m.genres.join(", ")}</div>
        <div class="card-actions">
          <button class="btn" onclick="playMovie(${i})">${m.episodeIds?.length?"Episodes":"Play"}</button>
          <button class="btn" onclick="addToWatchlist(${i})">Add to List</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });
}

// Filters
function populateFilters(){
  genreFilter.innerHTML='<option value="">All genres</option>';
  yearFilter.innerHTML='<option value="">All years</option>';
  const genres = new Set();
  const years = new Set();
  movies.forEach(m=>{ m.genres.forEach(g=>genres.add(g)); years.add(m.year); });
  genres.forEach(g=>{ const o=document.createElement("option"); o.value=g; o.innerText=g; genreFilter.appendChild(o); });
  [...years].sort((a,b)=>b-a).forEach(y=>{ const o=document.createElement("option"); o.value=y; o.innerText=y; yearFilter.appendChild(o); });
}

// Play movie or episodes
function playMovie(i){
  const m = movies[i];
  const w = window.open("", "_blank");
  if(m.episodeIds?.length){
    let epList = m.episodeIds.map((ep,idx)=>`<li><button onclick="playEpisode('${ep.file}')">${ep.title}</button></li>`).join("");
    w.document.write(`<h2>${m.title}</h2><ul>${epList}</ul><p>${m.description}</p>`);
  }else{
    w.document.write(`<h2>${m.title}</h2><video controls autoplay src="${m.fileId}" style="width:100%;max-width:700px"></video><p>${m.description}</p>`);
  }
}
function playEpisode(file){
  const w = window.open("", "_blank");
  w.document.write(`<video controls autoplay src="${file}" style="width:100%;max-width:700px"></video>`);
}

// Watchlist
function addToWatchlist(i){
  const m = movies[i];
  if(watchlist.some(w=>w.title===m.title)){ alert("Already in list"); return; }
  watchlist.push(m);
  localStorage.setItem("watchlist",JSON.stringify(watchlist));
  updateWatchlistCount();
  alert("Added!");
}
function updateWatchlistCount(){
  document.getElementById("watchlistToggle").textContent=`Watchlist (${watchlist.length})`;
}
document.getElementById("watchlistToggle").onclick = ()=>{
  const container = document.getElementById("watchlistContainer");
  container.innerHTML="";
  if(watchlist.length===0) container.innerHTML="<p>No movies yet.</p>";
  else watchlist.forEach((m,i)=>{
    const div = document.createElement("div");
    div.className="watchlist-card";
    div.innerHTML=`<img src="${m.poster}" alt="${m.title}"><div>${m.title}</div><button class="remove-btn" onclick="removeFromWatchlist(${i})">Remove</button>`;
    container.appendChild(div);
  });
  document.getElementById("watchlistModal").style.display="flex";
}
function closeModal(id){document.getElementById(id).style.display="none";}
function removeFromWatchlist(i){watchlist.splice(i,1); localStorage.setItem("watchlist",JSON.stringify(watchlist)); updateWatchlistCount(); document.getElementById("watchlistToggle").click();}

// Admin panel toggle
document.getElementById("adminLogin").onclick = ()=>{
  const p = document.getElementById("adminPanel");
  p.style.display = p.style.display==="block"?"none":"block";
  renderAdminMovieList();
}

// Admin: add episode temporarily
document.getElementById("addEpisodeBtn").onclick=async ()=>{
  const file=document.getElementById("episodeFile").files[0];
  const title=document.getElementById("episodeTitle").value.trim();
  if(!file || !title){ alert("Episode title & file required"); return; }
  try{
    const url = await uploadFile(file,"episode");
    tempEpisodes.push({title,file:url});
    renderTempEpisodes();
    document.getElementById("episodeFile").value=""; document.getElementById("episodeTitle").value="";
  }catch(e){alert("Upload failed: "+e.message);}
}
function renderTempEpisodes(){
  const container=document.getElementById("episodeListAdmin");
  container.innerHTML=tempEpisodes.map((ep,i)=>`<div>${ep.title} <button onclick="removeTempEpisode(${i})">Remove</button></div>`).join("");
}
window.removeTempEpisode=function(i){ tempEpisodes.splice(i,1); renderTempEpisodes(); }

// Admin: add movie
document.getElementById("addMovieBtn").onclick=async ()=>{
  const title=document.getElementById("movieTitle").value.trim();
  const year=parseInt(document.getElementById("movieYear").value);
  const genres=document.getElementById("movieGenres").value.split(",").map(g=>g.trim()).filter(g=>g);
  const desc=document.getElementById("movieDesc").value.trim();
  const trailer=document.getElementById("movieTrailer").value.trim();
  if(!title||!year||!genres.length){ alert("Fill required fields"); return; }

  let posterFile=document.getElementById("moviePosterFile").files[0];
  let movieFile=document.getElementById("movieFile").files[0];
  let posterUrl="", movieUrl="";
  try{ if(posterFile) posterUrl=await uploadFile(posterFile,"poster"); }catch(e){alert("Poster upload failed"); return;}
  try{ if(movieFile) movieUrl=await uploadFile(movieFile,"movie"); }catch(e){alert("Movie upload failed"); return;}

  const movieData={title,year,genres,poster:posterUrl, fileId:movieUrl, trailer, description:desc, episodeIds:[...tempEpisodes]};
  movies.push(movieData);
  tempEpisodes=[];
  renderMovies();
  populateFilters();
  renderAdminMovieList();
  saveMovies();
  alert("Movie added!");
  document.querySelectorAll('#adminPanel input, #adminPanel textarea').forEach(inp=>inp.value="");
}

function renderAdminMovieList(){
  const container=document.getElementById("adminMovieList");
  container.innerHTML="";
  movies.forEach((m,i)=>{
    const div=document.createElement("div");
    div.style.padding="4px 0";
    div.innerHTML=`${m.title} (${m.year}) <button onclick="editMovie(${i})">Edit</button> <button onclick="deleteMovie(${i})">Delete</button>`;
    container.appendChild(div);
  });
}

window.deleteMovie=function(i){ if(confirm("Delete?")){ movies.splice(i,1); renderMovies(); renderAdminMovieList(); saveMovies(); } }

window.editMovie=function(i){
  editIndex=i;
  const m=movies[i];
  document.getElementById("movieTitle").value=m.title;
  document.getElementById("movieYear").value=m.year;
  document.getElementById("movieGenres").value=m.genres.join(", ");
  document.getElementById("movieDesc").value=m.description;
  document.getElementById("movieTrailer").value=m.trailer;
  tempEpisodes=[...(m.episodeIds||[])];
  renderTempEpisodes();
  document.getElementById("addMovieBtn").style.display="none";
  document.getElementById("editMovieBtn").style.display="inline-block";
}

document.getElementById("editMovieBtn").onclick=async ()=>{
  const title=document.getElementById("movieTitle").value.trim();
  const year=parseInt(document.getElementById("movieYear").value);
  const genres=document.getElementById("movieGenres").value.split(",").map(g=>g.trim()).filter(g=>g);
  const desc=document.getElementById("movieDesc").value.trim();
  const trailer=document.getElementById("movieTrailer").value.trim();
  if(!title||!year||!genres.length){ alert("Fill required fields"); return; }

  let posterFile=document.getElementById("moviePosterFile").files[0];
  let movieFile=document.getElementById("movieFile").files[0];
  try{ if(posterFile) movies[editIndex].poster=await uploadFile(posterFile,"poster"); }catch(e){alert("Poster upload failed"); return;}
  try{ if(movieFile) movies[editIndex].fileId=await uploadFile(movieFile,"movie"); }catch(e){alert("Movie upload failed"); return;}

  movies[editIndex]={...movies[editIndex],title,year,genres,description:desc,trailer,episodeIds:[...tempEpisodes]};
  tempEpisodes=[];
  renderMovies(); renderAdminMovieList(); saveMovies();
  document.getElementById("addMovieBtn").style.display="inline-block"; document.getElementById("editMovieBtn").style.display="none";
  document.querySelectorAll('#adminPanel input, #adminPanel textarea').forEach(inp=>inp.value="");
}

function saveMovies(){
  fetch("save_movies.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(movies)});
}

// Filters events
searchInput.oninput=renderMovies;
genreFilter.onchange=renderMovies;
yearFilter.onchange=renderMovies;

renderMovies(); populateFilters(); updateWatchlistCount();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="img/logo.png" type="image/png">
<title>MovieDrift</title>
<style>
:root {
  --bg:#000; --card-bg:#0a0a0a; --accent:#00ff66; --text:#ddd; --muted:#888;
}
body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); }
header { display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px 20px; flex-wrap:wrap; }
.logo { font-size:24px; font-weight:bold; color: var(--accent); }
.controls { display:flex; gap:10px; flex-wrap:wrap; }
input, select, button, textarea { padding:6px 10px; border:1px solid var(--accent); border-radius:4px; background: var(--card-bg); color: var(--text); }
button { cursor:pointer; font-weight:bold; } button:hover { background:#003300; }
main { padding:20px; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:20px; }
.card { background: var(--card-bg); border:1px solid rgba(0,255,102,0.15); border-radius:8px; overflow:hidden; display:flex; flex-direction:column; transition: transform 0.2s; }
.card:hover { transform: scale(1.05); }
.poster { width:100%; height:300px; object-fit:cover; }
.card-body { padding:10px; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between; }
.movie-title { font-size:16px; font-weight:bold; color:var(--accent); margin:0; }
.meta { font-size:13px; color:var(--muted); margin:4px 0; }
.card-actions { display:flex; gap:5px; flex-wrap:wrap; }
.btn { flex:1; text-align:center; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; overflow-y:auto; }
.modal-content { background:var(--card-bg); max-width:900px; width:95%; max-height:90vh; overflow-y:auto; border-radius:8px; padding:20px; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; color:var(--accent); font-size:22px; }
iframe, video { width:100%; height:400px; border-radius:6px; }
#adminPanel { display:none; padding:20px; background:var(--card-bg); border-top:1px solid rgba(0,255,102,0.15); }
#adminPanel h3 { color:var(--accent); margin-bottom:10px; }
.form-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:15px; }
label { font-size:13px; color:var(--muted); margin-bottom:3px; display:block; }
.form-control { display:flex; flex-direction:column; }
textarea { resize:vertical; min-height:80px; }
.submit-row { margin-top:15px; text-align:right; }
#watchlistModal h2 { color:var(--accent); margin-bottom:15px; }
#watchlistModal .movie-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:15px; }
.watchlist-card { background:#111; border-radius:8px; padding:10px; text-align:center; transition:transform 0.2s; }
.watchlist-card:hover { transform:scale(1.05); background:#181818; }
.watchlist-card img { width:100%; border-radius:6px; margin-bottom:6px; }
.remove-btn { margin-top:6px; padding:4px 8px; border:none; border-radius:4px; background:#e63946; color:white; cursor:pointer; font-size:0.8rem; }
.remove-btn:hover { background:#c82333; }
.episode-list { margin-top:10px; }
.episode-list button { margin:2px; font-size:0.8rem; }
/* Progress Bar Styles */
#progressContainer { grid-column: span 2; margin-top: 10px; background: #222; border: 1px solid #00ff66; border-radius: 6px; overflow: hidden; height: 20px; width: 100%; }
#progressBar { height: 100%; width: 0%; background: #00ff66; text-align: center; color: #000; font-size: 12px; line-height: 20px; }
#progressText { color: var(--accent); font-size: 12px; margin-bottom: 3px; }
</style>
</head>
<body>
<header>
  <div class="logo">MovieDrift</div>
  <div class="controls">
    <input id="search" type="search" placeholder="Search movies...">
    <select id="genreFilter"><option value="">All genres</option></select>
    <select id="yearFilter"><option value="">All years</option></select>
    <button id="watchlistToggle">Watchlist (0)</button>
    <button id="adminLogin">Admin Login</button>
  </div>
</header>

<main><div id="grid" class="grid"></div></main>

<section id="adminPanel">
  <h3>âž• Add/Edit Movie</h3>
  <div class="form-grid">
    <div class="form-control"><label>Title</label><input id="movieTitle" type="text"></div>
    <div class="form-control"><label>Year</label><input id="movieYear" type="number"></div>
    <div class="form-control"><label>Genres (comma separated)</label><input id="movieGenres" type="text"></div>
    <div class="form-control"><label>Poster Image</label><input id="moviePosterFile" type="file" accept="image/*"></div>
    <div class="form-control"><label>Poster URL (optional)</label><input id="moviePosterURL" type="url"></div>
    <div class="form-control"><label>Movie File (MP4)</label><input id="movieFile" type="file" accept="video/mp4"></div>
    <div class="form-control"><label>Trailer/Embed Link (YouTube)</label><input id="movieTrailer" type="url"></div>
    <div class="form-control"><label>Episodes (MP4, select multiple)</label><input id="seriesEpisodes" type="file" accept="video/mp4" multiple></div>
    <div class="form-control" style="grid-column: span 2;">
      <label>Description</label><textarea id="movieDesc"></textarea>
    </div>
    <div id="progressContainer" style="grid-column: span 2;">
      <div id="progressText">Progress: 0%</div>
      <div id="progressBar"></div>
    </div>
  </div>
  <div class="submit-row">
    <button id="addMovieBtn">Add Movie/Series</button>
    <button id="editMovieBtn" style="display:none;">Save Changes</button>
  </div>
  <h3>ðŸ“‹ Manage Movies</h3>
  <div id="adminMovieList"></div>
</section>

<div class="modal" id="movieModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('movieModal')">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalYear"></p>
    <p id="modalGenres"></p>
    <div id="modalPlayer"></div>
    <div class="episode-list" id="episodeList"></div>
    <p id="modalDesc"></p>
    <button id="modalAddToList" class="btn">âž• Add to Watchlist</button>
  </div>
</div>

<div class="modal" id="watchlistModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('watchlistModal')">&times;</span>
    <h2>ðŸ“º Your Watchlist</h2>
    <div class="movie-list" id="watchlistContainer"></div>
  </div>
</div>

<script>
let movies = [];
let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];
let editIndex=null;

const grid=document.getElementById("grid");
const searchInput=document.getElementById("search");
const genreFilter=document.getElementById("genreFilter");
const yearFilter=document.getElementById("yearFilter");

// Load movies from JSON
async function loadMovies(){
  try{
    const res=await fetch("movies.json");
    const json=await res.json();
    movies=json;
    renderMovies();
    populateFilters();
    renderAdminMovies();
  }catch(e){ console.warn("Failed loading movies.json",e); }
}
loadMovies();

// Save movies to JSON (backend)
async function saveMoviesToJSON() {
  try {
    const res = await fetch('save_movies.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(movies)
    });
    const data = await res.json();
    if(data.status !== "success") console.warn("Failed to save movies:", data.message);
  } catch(e) { console.error("Error saving movies:", e); }
}

function renderMovies(){
  grid.innerHTML="";
  const searchText=searchInput.value.toLowerCase();
  const genre=genreFilter.value;
  const year=yearFilter.value;
  const filtered=movies.filter(m=>{
    const s=m.title.toLowerCase().includes(searchText)||m.description.toLowerCase().includes(searchText);
    const g=genre?m.genres.includes(genre):true;
    const y=year?m.year==year:true;
    return s&&g&&y;
  });
  filtered.forEach((m,i)=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<img class="poster" src="${m.poster}" alt="${m.title}"><div class="card-body"><h3 class="movie-title">${m.title}</h3><div class="meta">${m.year} Â· ${m.genres.join(", ")}</div><div class="card-actions"><button class="btn" onclick="viewDetails(${i})">Details</button><button class="btn" onclick="addToWatchlist(${i})">Add to List</button></div></div>`;
    grid.appendChild(card);
  });
}

function populateFilters(){
  genreFilter.innerHTML='<option value="">All genres</option>'; yearFilter.innerHTML='<option value="">All years</option>';
  let genres=new Set(); let years=new Set();
  movies.forEach(m=>{ m.genres.forEach(g=>genres.add(g)); years.add(m.year); });
  genres.forEach(g=>{ const o=document.createElement("option"); o.value=g; o.innerText=g; genreFilter.appendChild(o); });
  [...years].sort((a,b)=>b-a).forEach(y=>{ const o=document.createElement("option"); o.value=y; o.innerText=y; yearFilter.appendChild(o); });
}

function convertYouTubeLink(url){
  if(url.includes("youtube.com/watch?v=")){ const vid=url.split("v=")[1].split("&")[0]; return `https://www.youtube.com/embed/${vid}`; }
  if(url.includes("youtu.be/")){ const vid=url.split("youtu.be/")[1].split("?")[0]; return `https://www.youtube.com/embed/${vid}`; }
  return url;
}

function viewDetails(i){
  const m=movies[i];
  document.getElementById("modalTitle").innerText=m.title;
  document.getElementById("modalYear").innerText="Year: "+m.year;
  document.getElementById("modalGenres").innerText="Genres: "+m.genres.join(", ");
  const player=document.getElementById("modalPlayer");
  const epList=document.getElementById("episodeList");
  epList.innerHTML="";
  
  if(m.fileId){
    player.innerHTML=`<video controls src="${m.fileId}" autoplay></video>`;
  } else if(m.trailer){
    player.innerHTML=`<iframe src="${convertYouTubeLink(m.trailer)}" frameborder="0" allowfullscreen></iframe>`;
  } else {
    player.innerHTML="<p>No video available</p>";
  }

  if(m.episodeIds && m.episodeIds.length>0){
    m.episodeIds.forEach((ep,idx)=>{
      const btn=document.createElement("button");
      btn.textContent="Episode "+(idx+1);
      btn.onclick=()=>{ player.innerHTML=`<video controls src="${ep}" autoplay></video>`; };
      epList.appendChild(btn);
    });
  }

  document.getElementById("modalDesc").innerText=m.description;
  document.getElementById("modalAddToList").onclick=()=>addToWatchlist(i);
  document.getElementById("movieModal").style.display="flex";
}

function closeModal(id){
  document.getElementById(id).style.display="none";
  if(id==="movieModal") document.getElementById("modalPlayer").innerHTML="";
}

function addToWatchlist(i){
  const m=movies[i];
  if(watchlist.some(w=>w.title===m.title)){ alert("Already in list"); return; }
  watchlist.push(m);
  localStorage.setItem("watchlist",JSON.stringify(watchlist));
  updateWatchlistCount();
  alert("Added!");
}

function updateWatchlistCount(){
  document.getElementById("watchlistToggle").textContent=`Watchlist (${watchlist.length})`;
}

document.getElementById("watchlistToggle").addEventListener("click",()=>{
  const container=document.getElementById("watchlistContainer");
  container.innerHTML="";
  if(watchlist.length===0) container.innerHTML="<p>No movies yet.</p>";
  else watchlist.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="watchlist-card";
    div.innerHTML=`<img src="${m.poster}" alt="${m.title}"><h4>${m.title}</h4><p>${m.year} Â· ${m.genres.join(", ")}</p><button class="remove-btn" onclick="removeFromWatchlist(${i})">Remove</button>`;
    container.appendChild(div);
  });
  document.getElementById("watchlistModal").style.display="flex";
});

function removeFromWatchlist(i){
  watchlist.splice(i,1);
  localStorage.setItem("watchlist",JSON.stringify(watchlist));
  updateWatchlistCount();
  document.getElementById("watchlistToggle").click();
}

// Admin login
document.getElementById("adminLogin").addEventListener("click",()=>{
  const pwd=prompt("Enter admin password:");
  if(pwd==="@Stone001"){
    document.getElementById("adminPanel").style.display="block";
    renderAdminMovies();
    alert("Admin mode activated");
  } else alert("Wrong password");
});

// Upload file with progress
async function uploadFile(file, type){
  return new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    const form = new FormData();
    form.append("file", file);
    form.append("type", type);

    xhr.upload.addEventListener("progress", e=>{
      if(e.lengthComputable){
        const percent = Math.round((e.loaded / e.total) * 100);
        document.getElementById("progressBar").style.width = percent + "%";
        document.getElementById("progressBar").innerText = percent + "%";
        document.getElementById("progressText").innerText = `Uploading ${file.name} (${percent}%)`;
      }
    });

    xhr.onreadystatechange = ()=>{
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          try{
            const data = JSON.parse(xhr.responseText);
            if(data.status==="success") resolve(data.url);
            else reject("Upload failed for "+file.name);
          } catch(err){ reject(err); }
        } else reject("Upload failed with status "+xhr.status);
      }
    }

    xhr.open("POST","upload.php",true);
    xhr.send(form);
  });
}

// Add Movie with progress
document.getElementById("addMovieBtn").addEventListener("click", async ()=>{
  const title=document.getElementById("movieTitle").value.trim();
  const year=document.getElementById("movieYear").value.trim();
  const genres=document.getElementById("movieGenres").value.trim().split(",").map(g=>g.trim()).filter(Boolean);
  const desc=document.getElementById("movieDesc").value.trim();
  const posterFile=document.getElementById("moviePosterFile").files[0];
  const posterURL=document.getElementById("moviePosterURL").value.trim();
  const movieFile=document.getElementById("movieFile").files[0];
  const trailer=document.getElementById("movieTrailer").value.trim();
  const episodeFiles=document.getElementById("seriesEpisodes").files;

  if(!title||!year||!genres.length||(!posterFile&&!posterURL)||(!movieFile&&!trailer&&!episodeFiles.length)||!desc){
    alert("Please fill all fields"); 
    return;
  }

  // Reset progress
  document.getElementById("progressBar").style.width="0%";
  document.getElementById("progressBar").innerText="0%";
  document.getElementById("progressText").innerText="Starting upload...";

  try{
    let posterSrc = posterURL;
    if(posterFile) posterSrc = await uploadFile(posterFile, "poster");

    let movieSrc = "";
    if(movieFile) movieSrc = await uploadFile(movieFile, "movie");

    let episodes = [];
    for(let i=0;i<episodeFiles.length;i++){
      const epURL = await uploadFile(episodeFiles[i], "episode");
      episodes.push(epURL);
    }

    const newMovie = {
      title,
      year,
      genres,
      poster:posterSrc,
      fileId:movieSrc,
      trailer,
      description:desc,
      episodeIds:episodes
    };

    movies.push(newMovie);
    renderMovies();
    renderAdminMovies();
    await saveMoviesToJSON();

    document.getElementById("progressBar").style.width="100%";
    document.getElementById("progressBar").innerText="Done!";
    document.getElementById("progressText").innerText="All uploads completed!";
    alert("Movie/Series added successfully");

  } catch(e){
    console.error(e);
    document.getElementById("progressBar").style.width="100%";
    document.getElementById("progressBar").innerText="Failed!";
    document.getElementById("progressText").innerText="Upload failed!";
    alert("Upload failed, check console.");
  }
});

// Admin movie list
function renderAdminMovies(){
  const list=document.getElementById("adminMovieList");
  list.innerHTML="";
  movies.forEach((m,i)=>{
    const div=document.createElement("div");
    div.innerHTML=`<strong>${m.title}</strong> (${m.year}) <button onclick="editMovie(${i})">Edit</button> <button onclick="deleteMovie(${i})">Delete</button>`;
    list.appendChild(div);
  });
}

function editMovie(i){
  const m=movies[i];
  document.getElementById("movieTitle").value=m.title;
  document.getElementById("movieYear").value=m.year;
  document.getElementById("movieGenres").value=m.genres.join(",");
  document.getElementById("movieDesc").value=m.description;
  document.getElementById("moviePosterURL").value=m.poster;
  document.getElementById("addMovieBtn").style.display="none";
  document.getElementById("editMovieBtn").style.display="inline";
  editIndex=i;
}

document.getElementById("editMovieBtn").addEventListener("click",async()=>{
  const m=movies[editIndex];
  m.title=document.getElementById("movieTitle").value.trim();
  m.year=document.getElementById("movieYear").value.trim();
  m.genres=document.getElementById("movieGenres").value.trim().split(",").map(g=>g.trim()).filter(Boolean);
  m.description=document.getElementById("movieDesc").value.trim();
  m.poster=document.getElementById("moviePosterURL").value.trim();
  await saveMoviesToJSON();
  renderMovies();
  renderAdminMovies();
  document.getElementById("addMovieBtn").style.display="inline";
  document.getElementById("editMovieBtn").style.display="none";
  editIndex=null;
  alert("Movie updated");
});

function deleteMovie(i){
  if(confirm("Delete this movie?")){ movies.splice(i,1); saveMoviesToJSON(); renderMovies(); renderAdminMovies(); }
}

searchInput.addEventListener("input", renderMovies);
genreFilter.addEventListener("change", renderMovies);
yearFilter.addEventListener("change", renderMovies);
updateWatchlistCount();
</script>
</body>
</html>

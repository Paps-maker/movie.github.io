<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="img/logo.png" type="image/png">
<title>MovieDrift</title>
<style>
:root {
  --bg:#000; --card-bg:#0a0a0a; --accent:#00ff66; --text:#ddd; --muted:#888;
}
body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); }
header { display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px 20px; flex-wrap:wrap; }
.logo { font-size:24px; font-weight:bold; color: var(--accent); }
.controls { display:flex; gap:10px; flex-wrap:wrap; }
input, select, button, textarea { padding:6px 10px; border:1px solid var(--accent); border-radius:4px; background: var(--card-bg); color: var(--text); }
button { cursor:pointer; font-weight:bold; } button:hover { background:#003300; }
main { padding:20px; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:20px; }
.card { background: var(--card-bg); border:1px solid rgba(0,255,102,0.15); border-radius:8px; overflow:hidden; display:flex; flex-direction:column; transition: transform 0.2s; }
.card:hover { transform: scale(1.05); }
.poster { width:100%; aspect-ratio: 2/3; object-fit:cover; } 
.card-body { padding:10px; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between; }
.movie-title { font-size:16px; font-weight:bold; color:var(--accent); margin:0; }
.meta { font-size:13px; color:var(--muted); margin:4px 0; }
.card-actions { display:flex; gap:5px; flex-wrap:wrap; }
.btn { flex:1; text-align:center; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; overflow-y:auto; }
.modal-content { background:var(--card-bg); max-width:900px; width:95%; max-height:90vh; overflow-y:auto; border-radius:8px; padding:20px; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; color:var(--accent); font-size:22px; }
iframe, video { width:100%; height:400px; border-radius:6px; }
#watchlistModal h2 { color:var(--accent); margin-bottom:15px; }
#watchlistModal .movie-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:15px; }
.watchlist-card { background:#111; border-radius:8px; padding:10px; text-align:center; transition:transform 0.2s; }
.watchlist-card:hover { transform:scale(1.05); background:#181818; }
.watchlist-card img { width:100%; aspect-ratio: 2/3; object-fit:cover; margin-bottom:6px; }
.remove-btn { margin-top:6px; padding:4px 8px; border:none; border-radius:4px; background:#e63946; color:white; cursor:pointer; font-size:0.8rem; }
.remove-btn:hover { background:#c82333; }
.episode-list { margin-top:10px; }
.episode-list button { margin:2px; font-size:0.8rem; }
</style>
</head>
<body>
<header>
  <div class="logo">MovieDrift</div>
  <div class="controls">
    <input id="search" type="search" placeholder="Search movies...">
    <select id="typeFilter">
      <option value="">All types</option>
      <option value="Movie">Movie</option>
      <option value="Series">Series</option>
      <option value="Animation">Animation</option>
    </select>
    <select id="genreFilter"><option value="">All genres</option></select>
    <select id="yearFilter"><option value="">All years</option></select>
    <button id="watchlistToggle">Watchlist (0)</button>
  </div>
</header>

<main><div id="grid" class="grid"></div></main>

<div class="modal" id="movieModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('movieModal')">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalYear"></p>
    <p id="modalGenres"></p>
    <div id="modalPlayer"></div>
    <div class="episode-list" id="episodeList"></div>
    <p id="modalDesc"></p>
    <button id="modalAddToList" class="btn">‚ûï Add to Watchlist</button>
  </div>
</div>

<div class="modal" id="watchlistModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('watchlistModal')">&times;</span>
    <h2>üì∫ Your Watchlist</h2>
    <div class="movie-list" id="watchlistContainer"></div>
  </div>
</div>

<script>
let movies = [];
let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];

async function loadMovies() {
  try {
    const res = await fetch("movies.json");
    movies = await res.json();
    populateFilters();
    renderMovies();
  } catch (e) { console.warn("Failed to load movies.json", e); }
}
loadMovies();

function populateFilters() {
  const genreSet = new Set();
  const yearSet = new Set();
  movies.forEach(m => {
    m.genres.forEach(g => genreSet.add(g));
    yearSet.add(m.year);
  });
  const genreFilter = document.getElementById("genreFilter");
  genreSet.forEach(g => { const opt=document.createElement("option"); opt.value=g; opt.textContent=g; genreFilter.appendChild(opt); });
  const yearFilter = document.getElementById("yearFilter");
  Array.from(yearSet).sort((a,b)=>b-a).forEach(y=>{ const opt=document.createElement("option"); opt.value=y; opt.textContent=y; yearFilter.appendChild(opt); });
}

function renderMovies() {
  const grid = document.getElementById("grid");
  const searchText = document.getElementById("search").value.toLowerCase();
  const selectedGenre = document.getElementById("genreFilter").value;
  const selectedYear = document.getElementById("yearFilter").value;
  const selectedType = document.getElementById("typeFilter").value;
  grid.innerHTML = "";

  const filtered = movies.filter(m => {
    const matchesSearch = m.title.toLowerCase().includes(searchText);
    const matchesGenre = !selectedGenre || m.genres.includes(selectedGenre);
    const matchesYear = !selectedYear || m.year == selectedYear;
    const matchesType = !selectedType || m.type === selectedType;
    return matchesSearch && matchesGenre && matchesYear && matchesType;
  });

  filtered.forEach((m, index) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img class="poster" src="${m.poster}" alt="${m.title}">
      <div class="card-body">
        <h3 class="movie-title">${m.title}</h3>
        <div class="meta">${m.year} ¬∑ ${m.genres.join(", ")}</div>
        <div class="card-actions">
          <button class="btn" onclick="viewDetails(${index})">Details</button>
          <button class="btn" onclick="addToWatchlist(${index})">Add to List</button>
          ${m.trailer ? `<button class="btn" onclick="watchTrailer(${index})">Watch</button>` : ''}
        </div>
      </div>`;
    grid.appendChild(card);
  });
}

function convertYouTubeLink(url) {
  try { 
    let videoId = '';
    if(url.includes("youtube.com/watch?v=")) videoId = url.split("v=")[1].split("&")[0];
    else if(url.includes("youtu.be/")) videoId = url.split("youtu.be/")[1].split("?")[0];
    else return url;
    return `https://www.youtube.com/embed/${videoId}?rel=0`;
  } catch { return url; }
}

function viewDetails(i){
  const m = movies[i];
  const player = document.getElementById("modalPlayer");
  const episodeList = document.getElementById("episodeList");
  player.innerHTML = ""; episodeList.innerHTML = "";

  if(m.fileUrl){
    if(m.fileUrl.includes("vidsrc") || m.fileUrl.includes("wootly.ch")){
      player.innerHTML = `<iframe src="${m.fileUrl}" frameborder="0" allowfullscreen></iframe>`;
    } else {
      player.innerHTML = `<video controls src="${m.fileUrl}"></video>`;
    }
  } else if(m.trailer){
    player.innerHTML = `<iframe src="${convertYouTubeLink(m.trailer)}" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
  } else { player.innerHTML = "<p>No video available</p>"; }

  if(m.episodeIds && m.episodeIds.length>0){
    m.episodeIds.forEach((ep,idx)=>{
      const btn = document.createElement("button");
      btn.textContent = "Episode "+(idx+1);
      btn.onclick = ()=>{ player.innerHTML = `<video controls src="${ep}"></video>`; };
      episodeList.appendChild(btn);
    });
  }

  document.getElementById("modalTitle").innerText = m.title;
  document.getElementById("modalYear").innerText = "Year: "+m.year;
  document.getElementById("modalGenres").innerText = "Genres: "+m.genres.join(", ");
  document.getElementById("modalDesc").innerText = m.description || "";
  document.getElementById("movieModal").style.display = "flex";
  document.getElementById("modalAddToList").onclick = ()=>addToWatchlist(i);

  // Push state for back button
  history.pushState({modalOpen:true}, "", "");
}

function watchTrailer(i){ viewDetails(i); }

function addToWatchlist(i){
  if(!watchlist.find(m => m.title===movies[i].title)){
    watchlist.push(movies[i]); saveWatchlist(); alert("‚úÖ Added to Watchlist");
  } else alert("‚ö†Ô∏è Already in Watchlist");
  updateWatchlistButton();
}

function showWatchlist(){
  const container = document.getElementById("watchlistContainer"); container.innerHTML="";
  if(!watchlist.length) container.innerHTML="<p>No movies yet.</p>";
  else watchlist.forEach((m,idx)=>{
    const div=document.createElement("div");
    div.className="watchlist-card";
    div.innerHTML=`<img src="${m.poster}" alt="${m.title}"><h4>${m.title}</h4><p>${m.year}</p><button class="remove-btn" onclick="removeFromWatchlist(${idx})">Remove</button>`;
    container.appendChild(div);
  });
  document.getElementById("watchlistModal").style.display="flex";
}

function removeFromWatchlist(i){ watchlist.splice(i,1); saveWatchlist(); showWatchlist(); updateWatchlistButton(); }
function saveWatchlist(){ localStorage.setItem("watchlist", JSON.stringify(watchlist)); }
function updateWatchlistButton(){ document.getElementById("watchlistToggle").textContent=`Watchlist (${watchlist.length})`; }
updateWatchlistButton();
document.getElementById("watchlistToggle").onclick=showWatchlist;
function closeModal(id){ document.getElementById(id).style.display="none"; }

// Filters + search
document.getElementById("search").addEventListener("input", renderMovies);
document.getElementById("genreFilter").addEventListener("change", renderMovies);
document.getElementById("yearFilter").addEventListener("change", renderMovies);
document.getElementById("typeFilter").addEventListener("change", renderMovies);

// Handle browser back button
window.addEventListener("popstate", (event)=>{
  const modal = document.getElementById("movieModal");
  if(modal.style.display==="flex"){ modal.style.display="none"; }
});
</script>
</body>
</html>

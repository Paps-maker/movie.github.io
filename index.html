<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieDrift</title>
<link rel="icon" href="img/logo.png" type="image/png">
<style>
:root {
  --bg: #000;
  --card-bg: #0a0a0a;
  --accent: #00ff66;
  --text: #ddd;
  --muted: #888;
}
body { margin:0; font-family: Arial,sans-serif; background: var(--bg); color: var(--text);}
header { display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px 20px; flex-wrap:wrap;}
.logo { font-size:24px; font-weight:bold; color: var(--accent); }
.controls { display:flex; gap:10px; flex-wrap:wrap; }
input, select, button, textarea { padding:6px 10px; border:1px solid var(--accent); border-radius:4px; background:var(--card-bg); color: var(--text);}
button { cursor:pointer; font-weight:bold;}
button:hover { background:#003300; }
main { padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:20px;}
.card { background:var(--card-bg); border:1px solid rgba(0,255,102,0.15); border-radius:8px; overflow:hidden; display:flex; flex-direction:column; transition:transform 0.2s;}
.card:hover { transform: scale(1.05); }
.poster { width:100%; height:300px; object-fit:cover; }
.card-body { padding:10px; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between;}
.movie-title { font-size:16px; font-weight:bold; color:var(--accent); margin:0; }
.meta { font-size:13px; color:var(--muted); margin:4px 0; }
.card-actions { display:flex; gap:5px; flex-wrap:wrap; }
.btn { flex:1; text-align:center; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; overflow-y:auto;}
.modal-content { background:var(--card-bg); max-width:900px; width:95%; max-height:90vh; overflow-y:auto; border-radius:8px; padding:20px; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; color:var(--accent); font-size:22px; }
iframe, video { width:100%; height:400px; border-radius:6px; }
#adminPanel { display:none; padding:20px; background:var(--card-bg); border-top:1px solid rgba(0,255,102,0.15); }
#adminPanel h3 { color:var(--accent); margin-bottom:10px; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:15px; }
label { font-size:13px; color:var(--muted); margin-bottom:3px; display:block; }
.form-control { display:flex; flex-direction:column; }
textarea { resize:vertical; min-height:80px; }
.submit-row { margin-top:15px; text-align:right; }
#watchlistModal h2 { color:var(--accent); margin-bottom:15px; }
#watchlistModal .movie-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:15px; }
.watchlist-card { background:#111; border-radius:8px; padding:10px; text-align:center; transition:transform 0.2s; }
.watchlist-card:hover { transform:scale(1.05); background:#181818; }
.watchlist-card img { width:100%; border-radius:6px; margin-bottom:6px; }
.remove-btn { margin-top:6px; padding:4px 8px; border:none; border-radius:4px; background:#e63946; color:white; cursor:pointer; font-size:0.8rem;}
.remove-btn:hover { background:#c82333; }
.episode-list { margin-top:10px; }
.episode-list button { margin:2px; font-size:0.8rem; }
</style>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFVoYWgoxpRBxi3l3OUarvUn2_M9_lqqY",
  authDomain: "moviedrift-fcc93.firebaseapp.com",
  projectId: "moviedrift-fcc93",
  storageBucket: "moviedrift-fcc93.appspot.com",
  messagingSenderId: "794171988540",
  appId: "1:794171988540:web:0f3ab8798d0d7606b98139"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

window.db = db;
window.storage = storage;
</script>
</head>
<body>
<header>
  <div class="logo">MovieDrift</div>
  <div class="controls">
    <input id="search" type="search" placeholder="Search movies...">
    <select id="genreFilter"><option value="">All genres</option></select>
    <select id="yearFilter"><option value="">All years</option></select>
    <button id="watchlistToggle">Watchlist (0)</button>
    <button id="adminLogin">Admin Login</button>
  </div>
</header>
<main><div id="grid" class="grid"></div></main>

<section id="adminPanel">
  <h3>‚ûï Add a Movie/Series</h3>
  <div class="form-grid">
    <div class="form-control"><label>Title</label><input id="movieTitle" type="text"></div>
    <div class="form-control"><label>Year</label><input id="movieYear" type="number"></div>
    <div class="form-control"><label>Genres (comma separated)</label><input id="movieGenres" type="text"></div>
    <div class="form-control"><label>Poster Image</label><input id="moviePosterFile" type="file" accept="image/*"></div>
    <div class="form-control"><label>Movie File (MP4)</label><input id="movieFile" type="file" accept="video/mp4"></div>
    <div class="form-control"><label>Trailer/Embed Link (YouTube)</label><input id="movieTrailer" type="url"></div>
    <div class="form-control" style="grid-column: span 2;">
      <label>Description</label><textarea id="movieDesc"></textarea>
    </div>
  </div>
  <div class="submit-row"><button id="addMovieBtn">Add Movie/Series</button></div>
  <h3>üìã Manage Movies</h3>
  <div id="adminMovieList"></div>
</section>

<div class="modal" id="movieModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('movieModal')">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalYear"></p>
    <p id="modalGenres"></p>
    <div id="modalPlayer"></div>
    <p id="modalDesc"></p>
  </div>
</div>

<script type="module">
// Globals
let movies = [];
let watchlist = [];
const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");
const genreFilter = document.getElementById("genreFilter");
const yearFilter = document.getElementById("yearFilter");
const watchlistBtn = document.getElementById("watchlistToggle");
const adminLoginBtn = document.getElementById("adminLogin");

// Firebase refs
const { db, storage } = window;

// Upload file to Firebase Storage
async function uploadFile(file, path){
  const storageRef = ref(storage, path);
  await uploadBytes(storageRef, file);
  return await getDownloadURL(storageRef);
}

// Add movie to Firestore
async function addMovieToFirebase(movie){
  try{
    const docRef = await addDoc(collection(db,"movies"), movie);
    console.log("Movie added:", docRef.id);
    fetchMovies();
  }catch(e){ console.error(e); }
}

// Fetch movies from Firestore
async function fetchMovies(){
  const querySnapshot = await getDocs(collection(db,"movies"));
  movies = [];
  querySnapshot.forEach(doc => movies.push({ id:doc.id, ...doc.data() }));
  renderMovies();
  populateFilters();
}
fetchMovies();

// Render movie grid
function renderMovies(){
  grid.innerHTML="";
  const searchText = searchInput.value.toLowerCase();
  const genre = genreFilter.value;
  const year = yearFilter.value;
  let filtered = movies.filter(m => 
    (m.title.toLowerCase().includes(searchText) || m.description.toLowerCase().includes(searchText)) &&
    (genre ? m.genres.includes(genre) : true) &&
    (year ? m.year == year : true)
  );
  filtered.forEach((m,i)=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <img class="poster" src="${m.poster}" alt="${m.title}">
      <div class="card-body">
        <h3 class="movie-title">${m.title}</h3>
        <div class="meta">${m.year} ¬∑ ${m.genres.join(", ")}</div>
        <div class="card-actions">
          <button class="btn" onclick="viewDetails('${m.id}')">Details</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });
}

// Populate filters
function populateFilters(){
  const allGenres = new Set();
  const allYears = new Set();
  movies.forEach(m=>{
    m.genres.forEach(g=>allGenres.add(g));
    allYears.add(m.year);
  });
  genreFilter.innerHTML='<option value="">All genres</option>';
  allGenres.forEach(g=>genreFilter.innerHTML+=`<option value="${g}">${g}</option>`);
  yearFilter.innerHTML='<option value="">All years</option>';
  Array.from(allYears).sort((a,b)=>b-a).forEach(y=>yearFilter.innerHTML+=`<option value="${y}">${y}</option>`);
}

// Admin Login
adminLoginBtn.addEventListener("click", ()=>{
  const pwd = prompt("Enter admin password:");
  if(pwd==="@Stone001") document.getElementById("adminPanel").style.display="block";
  else alert("‚ùå Wrong password!");
});

// Add Movie
document.getElementById("addMovieBtn").addEventListener("click", async ()=>{
  const title = document.getElementById("movieTitle").value.trim();
  const year = document.getElementById("movieYear").value.trim();
  const genres = document.getElementById("movieGenres").value.trim().split(",").map(g=>g.trim()).filter(Boolean);
  const desc = document.getElementById("movieDesc").value.trim();
  const posterFile = document.getElementById("moviePosterFile").files[0];
  const movieFile = document.getElementById("movieFile").files[0];
  const trailer = document.getElementById("movieTrailer").value.trim();

  if(!title||!year||!genres.length||(!posterFile)||(!movieFile&&!trailer)||!desc){
    alert("‚ö†Ô∏è Please fill in all required fields!");
    return;
  }

  const posterURL = await uploadFile(posterFile, "posters/"+Date.now()+"_"+posterFile.name);
  let movieURL = "";
  if(movieFile) movieURL = await uploadFile(movieFile, "movies/"+Date.now()+"_"+movieFile.name);

  const movieData = { title, year, genres, poster: posterURL, video: movieURL, trailer, description: desc };
  addMovieToFirebase(movieData);
  alert("‚úÖ Movie added!");
});

// Search & Filters
searchInput.addEventListener("input", renderMovies);
genreFilter.addEventListener("change", renderMovies);
yearFilter.addEventListener("change", renderMovies);

// Modal
async function viewDetails(id){
  const movie = movies.find(m=>m.id===id);
  document.getElementById("modalTitle").innerText = movie.title;
  document.getElementById("modalYear").innerText = "Year: "+movie.year;
  document.getElementById("modalGenres").innerText = "Genres: "+movie.genres.join(", ");
  const player = document.getElementById("modalPlayer");
  if(movie.video) player.innerHTML=`<video controls src="${movie.video}"></video>`;
  else if(movie.trailer) player.innerHTML=`<iframe src="https://www.youtube.com/embed/${movie.trailer.split('v=')[1]}" frameborder="0" allowfullscreen></iframe>`;
  else player.innerHTML="<p>No video available</p>";
  document.getElementById("modalDesc").innerText = movie.description;
  document.getElementById("movieModal").style.display="flex";
}
function closeModal(id){ document.getElementById(id).style.display="none"; }
</script>
</body>
</html>

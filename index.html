<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="icon" href="img/logo.png" type="image/png">
<title>MovieDrift</title>

<style>
:root { --bg:#000; --card-bg:#0a0a0a; --accent:#00ff66; --text:#ddd; --muted:#888; }
body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color: var(--text);}
header { display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px 20px; flex-wrap:wrap;}
.logo { font-size:24px; font-weight:bold; color: var(--accent);}
.controls { display:flex; gap:10px; flex-wrap:wrap;}
input, select, button, textarea { padding:6px 10px; border:1px solid var(--accent); border-radius:4px; background: var(--card-bg); color: var(--text);}
button { cursor:pointer; font-weight:bold;}
button:hover { background:#003300;}
main { padding:20px;}
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:20px;}
.card { background: var(--card-bg); border:1px solid rgba(0,255,102,0.15); border-radius:8px; overflow:hidden; display:flex; flex-direction:column; transition: transform 0.2s;}
.card:hover { transform: scale(1.05);}
.poster { width:100%; aspect-ratio: 2/3; object-fit:cover;}
.card-body { padding:10px; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between;}
.movie-title { font-size:16px; font-weight:bold; color:var(--accent); margin:0;}
.meta { font-size:13px; color:var(--muted); margin:4px 0;}
.rating { font-size:13px; color:#ffcc00; margin:2px 0;}
.card-actions { display:flex; gap:5px; flex-wrap:wrap;}
.btn { flex:1; text-align:center;}

/* ---------------- FIXED MODAL ---------------- */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  justify-content:center;
  align-items:flex-start;
  z-index:1000;
  overflow-y:auto;
  padding:20px 0;
}
.modal-content {
  background:var(--card-bg);
  max-width:980px;
  width:95%;
  height:auto;
  max-height:none;
  overflow-y:visible;
  border-radius:8px;
  padding:20px;
  position:relative;
  margin:40px auto;
}
.close { position:absolute; top:10px; right:15px; cursor:pointer; color:var(--accent); font-size:22px;}
.modal-content iframe,
.modal-content video { width:100%; height:auto; max-height:60vh; border-radius:6px; margin-bottom:10px;}

/* Guest CTA */
.guest-cta { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
.call-btn, .wa-btn { padding:10px 12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; }
.call-btn { background:#00a676; color:#fff; }
.wa-btn { background:#25D366; color:#fff; }

/* WATCHLIST */
#watchlistModal h2 { color:var(--accent); margin-bottom:15px;}
#watchlistModal .movie-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:15px;}
.watchlist-card { background:#111; border-radius:8px; padding:10px; text-align:center; transition:transform 0.2s;}
.watchlist-card:hover { transform:scale(1.05); background:#181818;}
.watchlist-card img { width:100%; aspect-ratio: 2/3; object-fit:cover; margin-bottom:6px;}
.remove-btn { margin-top:6px; padding:4px 8px; border:none; border-radius:4px; background:#e63946; color:white; cursor:pointer; font-size:0.8rem;}
.remove-btn:hover { background:#c82333;}
.episode-list { margin-top:10px;}
.episode-list button { margin:2px; font-size:0.8rem;}

/* THEMES */
.theme-dark { --bg:#000; --card-bg:#0a0a0a; --accent:#00ff66; --text:#ddd; --muted:#888; }
.theme-white { --bg:#ffffff; --card-bg:#f2f2f2; --accent:#0066ff; --text:#000; --muted:#666; }
.theme-pink { --bg:#ffebf0; --card-bg:#ffd6e3; --accent:#ff2f8a; --text:#5a0032; --muted:#a64a6b; }
.theme-blue { --bg:#001122; --card-bg:#0a1a33; --accent:#00ccff; --text:#d0eaff; --muted:#88aacc; }
.theme-gold { --bg:#0d0c07; --card-bg:#1a1a10; --accent:#ffd700; --text:#fff4c2; --muted:#aa9955; }
.theme-purple { --bg:#120018; --card-bg:#25002f; --accent:#d800ff; --text:#f9d9ff; --muted:#b76cd8; }

@media (max-width: 600px) { .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } }
/* ---------------- MODAL BASE ---------------- */
#movieModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  overflow-y: auto;
  z-index: 1000;
  padding: 40px 20px;
  box-sizing: border-box;
  animation: fadeIn 0.3s ease-in-out;
}

#movieModal .modal-content {
  max-width: 900px;
  margin: 0 auto;
  background: #1a1a1a;
  padding: 20px 30px;
  border-radius: 10px;
  color: #fff;
  box-shadow: 0 5px 25px rgba(0,0,0,0.5);
}

#movieModal h4 {
  margin-top: 20px;
  font-size: 20px;
  color: #00ff66;
  border-bottom: 1px solid #333;
  padding-bottom: 5px;
}

/* ---------------- VIDEO WRAPPER ---------------- */
.video-wrapper, .episode-video-wrapper {
  position: relative;
  width: 100%;
  max-height: 500px;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}

.video-wrapper iframe, 
.episode-video-wrapper iframe,
.video-wrapper video,
.episode-video-wrapper video {
  width: 100%;
  height: 100%;
  border-radius: 8px;
}

/* ---------------- PLAY BUTTON ---------------- */
.play-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #00ff66;
  color: #000;
  font-weight: bold;
  border: none;
  padding: 12px 20px;
  font-size: 18px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s all;
}

.play-btn:hover {
  background: #00cc52;
}

/* ---------------- DOWNLOAD LINK ---------------- */
a.download-link, 
.episode-video-wrapper a {
  display: inline-block;
  margin-top: 10px;
  background: #00ff66;
  color: #000;
  font-weight: bold;
  padding: 8px 15px;
  border-radius: 6px;
  text-decoration: none;
  transition: 0.3s all;
}

a.download-link:hover,
.episode-video-wrapper a:hover {
  background: #00cc52;
}

/* ---------------- EPISODE LIST ---------------- */
.episode-list {
  margin-top: 10px;
}

.episode-list div {
  cursor: pointer;
  padding: 10px 12px;
  margin-bottom: 8px;
  background: #222;
  border-radius: 6px;
  transition: 0.2s all;
}

.episode-list div:hover {
  background: #333;
}

.episode-list strong {
  color: #00ff66;
}

.episode-list small {
  color: #ccc;
  display: block;
  margin-top: 3px;
}

/* ---------------- MODAL DETAILS ---------------- */
#modalTitle {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 6px;
}

#modalYear, #modalGenres, #modalRating, #modalDesc {
  font-size: 14px;
  color: #ccc;
  margin-bottom: 4px;
}

/* ---------------- ANIMATION ---------------- */
@keyframes fadeIn {
  0% { opacity: 0; transform: scale(0.98); }
  100% { opacity: 1; transform: scale(1); }
}

/* ---------------- RESPONSIVE ---------------- */
@media (max-width: 768px) {
  #movieModal .modal-content {
    padding: 15px 20px;
  }

  .play-btn {
    font-size: 16px;
    padding: 10px 16px;
  }

  a.download-link,
  .episode-video-wrapper a {
    font-size: 14px;
    padding: 6px 12px;
  }
}

</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:12px"><div class="logo">MovieDrift</div></div>

  <div class="controls">
    <select id="themeSelector" title="Theme">
       <option value="dark">Dark Green (Default)</option>
  <option value="white">White Mode</option>
  <option value="pink">Soft Pink</option>
  <option value="blue">Blue Neon</option>
  <option value="gold">Gold Premium</option>
  <option value="purple">Purple Night</option>
    </select>

    <input id="search" type="search" placeholder="Search movies...">
    <select id="typeFilter"><option value="">All types</option><option value="Movie">Movie</option><option value="Series">Series</option><option value="Animation">Animation</option></select>
    <select id="genreFilter"><option value="">All genres</option></select>
    <select id="yearFilter"><option value="">All years</option></select>

    <div id="authArea" style="display:flex;gap:8px;align-items:center">
      <button id="openAuthBtn" class="btn" style="padding:6px 10px;">Login</button>
      <button id="logoutBtn" class="btn" style="display:none;padding:6px 10px;">Logout</button>
    </div>

    <button id="watchlistToggle" class="btn" style="padding:6px 10px;">Watchlist (0)</button>
  </div>
</header>

<main><div id="grid" class="grid"></div></main>

<!-- Movie Modal -->
<div class="modal" id="movieModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('movieModal')">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalYear"></p>
    <p id="modalGenres"></p>
    <p class="rating" id="modalRating"></p>
    <div id="modalPlayer"></div>
    <div class="episode-list" id="episodeList"></div>
    <p id="modalDesc"></p>
    <button id="modalAddToList" class="btn">âž• Add to Watchlist</button>
  </div>
</div>

<!-- Guest Modal -->
<div class="modal" id="guestModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('guestModal')">&times;</span>
    <h2 id="guestGreeting">Welcome</h2>
    <p id="guestMessage"></p>
    <p style="color:var(--muted)">To enjoy streaming, downloads and add-to-list features you must have a premium account (150 KSh / month).</p>
    <div class="guest-cta">
      <a id="callLink" class="call-btn" href="tel:+254790427109"> Call Us</a>
      <a id="waLink" class="wa-btn" href="https://wa.me/254790427109"> WhatsApp</a>
      <button id="guestLoginBtn" class="btn" style="padding:8px 12px;">MOVIE DRIFT</button>
    </div>
  </div>
</div>

<!-- Watchlist Modal -->
<div class="modal" id="watchlistModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('watchlistModal')">&times;</span>
    <h2>ðŸ“º Your Watchlist</h2>
    <div class="movie-list" id="watchlistContainer"></div>
  </div>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('authModal')">&times;</span>
    <h2 id="authTitle">Sign in</h2>
    <div style="display:flex;gap:8px;flex-direction:column;max-width:420px;">
      <input id="authIdentifier" placeholder="Email or Username" type="text">
      <input id="authPassword" placeholder="Password (6+ chars)" type="password">
      <div style="display:flex;gap:8px;">
        <button id="signInBtn" class="btn">Sign In</button>
        <button id="registerBtn" class="btn"></button>
      </div>
      <div style="color:var(--muted);font-size:13px;margin-top:8px;">
        If you have no account contact our team to be registered.
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, onSnapshot, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD2gkLs17Oa_dxIGu1FpOaDKAvGZwj_EFA",
  authDomain: "gamers-65b44.firebaseapp.com",
  projectId: "gamers-65b44",
  storageBucket: "gamers-65b44.firebasestorage.app",
  messagingSenderId: "97331968745",
  appId: "1:97331968745:web:a93ff0bd2c383800dcce78",
  measurementId: "G-JPPCZ3M4G2"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let movies = [];
let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];
let currentUser = null;

const genreFilter = document.getElementById("genreFilter");
const yearFilter = document.getElementById("yearFilter");

/* UI elements */
const openAuthBtn = document.getElementById('openAuthBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authModal = document.getElementById('authModal');
const signInBtn = document.getElementById('signInBtn');
const registerBtn = document.getElementById('registerBtn');
const authIdentifier = document.getElementById('authIdentifier');
const authPassword = document.getElementById('authPassword');
const guestModal = document.getElementById('guestModal');
const guestLoginBtn = document.getElementById('guestLoginBtn');
const guestGreeting = document.getElementById('guestGreeting');
const guestMessage = document.getElementById('guestMessage');
const callLink = document.getElementById('callLink');
const waLink = document.getElementById('waLink');

/* ---------------- Persistent login & status tracking ---------------- */
function saveCurrentUser() {
  if(currentUser) localStorage.setItem('currentUser', JSON.stringify(currentUser));
  else localStorage.removeItem('currentUser');
}

function loadCurrentUser() {
  const saved = localStorage.getItem('currentUser');
  if(saved) currentUser = JSON.parse(saved);
  if(currentUser) watchUserStatus(); // Track status changes in real-time
}

function watchUserStatus() {
  if (!currentUser) return;
  const userDocRef = doc(db, "users", currentUser.id);
  onSnapshot(userDocRef, docSnap => {
    if(docSnap.exists()){
      currentUser.status = docSnap.data().status || "Unpaid";
      saveCurrentUser();
    }
  });
}

/* ---------------- Load movies ---------------- */
onSnapshot(collection(db, "movies"), snapshot => {
  movies = snapshot.docs.map(d => {
    const data = d.data();
    const createdAt = data.createdAt?.seconds ? data.createdAt.seconds*1000 : data.createdAt||0;
    const year = parseInt(data.year)||0;
    return { id:d.id, ...data, createdAt, year };
  }).sort((a,b)=>b.year!==a.year? b.year-a.year : b.createdAt-a.createdAt);
  populateFilters();
  renderMovies();
});

/* Filters */
function populateFilters() {
  const genreSet = new Set(), yearSet = new Set();
  movies.forEach(m => { if(m.genres) m.genres.forEach(g=>genreSet.add(g)); yearSet.add(m.year); });
  genreFilter.innerHTML = '<option value="">All genres</option>';
  yearFilter.innerHTML = '<option value="">All years</option>';
  genreSet.forEach(g=>genreFilter.innerHTML+=`<option value="${g}">${g}</option>`);
  Array.from(yearSet).sort((a,b)=>b-a).forEach(y=>yearFilter.innerHTML+=`<option value="${y}">${y}</option>`);
}

/* Render movies */
function renderMovies() {
  const grid = document.getElementById("grid");
  const searchText = document.getElementById("search").value.toLowerCase();
  const selectedGenre = genreFilter.value;
  const selectedYear = yearFilter.value;
  const selectedType = document.getElementById("typeFilter").value;
  grid.innerHTML = "";
  const filtered = movies.filter(m => {
    const matchesSearch = (m.title||'').toLowerCase().includes(searchText);
    const matchesGenre = !selectedGenre || (m.genres && m.genres.includes(selectedGenre));
    const matchesYear = !selectedYear || m.year == selectedYear;
    const matchesType = !selectedType || m.type === selectedType || !m.type;
    return matchesSearch && matchesGenre && matchesYear && matchesType;
  });

  filtered.forEach((m, index) => {
    const ratingText = m.rating ? `${m.rating.toFixed(1)} / 10 (${Math.round(m.rating*10)}%)` : "";
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img class="poster" src="${m.poster||''}" alt="${(m.title||'').replace(/"/g,'&quot;')}">
      <div class="card-body">
        <h3 class="movie-title">${(m.title||'').replace(/</g,'&lt;')}</h3>
        <div class="meta">${m.year || ''} Â· ${(m.genres||[]).join(", ")}</div>
        <div class="rating">${ratingText}</div>
        <div class="card-actions">
          <button class="btn" onclick="protectedAction('details', ${index})">Details</button>
          <button class="btn" onclick="protectedAction('add', ${index})">Add to List</button>
          <button class="btn" onclick="protectedAction('watch', ${index})">Watch</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });

  window.currentFiltered = filtered;
}

/* ---------------- Protected action ---------------- */
window.protectedAction = function(action, index) {
  if(currentUser){
    if(currentUser.status !== "Paid"){
      alert("âš  Your account is unpaid. Please contact support to regain access.");
      return;
    }
    if(action==='details') return viewDetailsByFiltered(index);
    if(action==='watch') return viewAndPlayByFiltered(index);
    if(action==='add') return addToWatchlistByFiltered(index);
  } else showGuestModal(action);
};

/* ---------------- Guest modal ---------------- */
function showGuestModal(actionHint='') {
  const h = new Date(); let greet='Hello';
  if(h.getHours()<12) greet='Good morning';
  else if(h.getHours()<18) greet='Good afternoon';
  else greet='Good evening';
  guestGreeting.innerText = `${greet}, Guest!`;
  guestMessage.innerHTML = `You're browsing in <strong>Guest mode</strong>. To use ${actionHint ? `<strong>${actionHint}</strong>` : 'premium features'} subscribe.<br><br>Subscription: <strong>150 KSh / month</strong>. Contact our team.`;
  const phone='+254790427109';
  waLink.href=`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent('Hi, I want a MovieDrift premium account')}`;
  callLink.href=`tel:${phone}`;
  document.getElementById('guestModal').style.display='flex';
  guestLoginBtn.onclick = () => { closeModal('guestModal'); openAuthModal(); };
}

/* ---------------- Auth system ---------------- */
async function loginUser(identifier,password){
  const usersRef = collection(db,"users");
  let q=query(usersRef,where("email","==",identifier));
  let snapshot = await getDocs(q);
  if(snapshot.empty){ q=query(usersRef,where("username","==",identifier)); snapshot=await getDocs(q); if(snapshot.empty){return alert("User not found");} }
  const userDoc=snapshot.docs[0];
  const user=userDoc.data();
  if(user.password===password){
    currentUser={id:userDoc.id,...user};
    saveCurrentUser();
    watchUserStatus(); // Start real-time status tracking
    alert("Logged in successfully");
    updateAuthUI();
    closeModal('authModal');
  } else alert("Incorrect password");
}

async function registerUser(identifier,password){
  if(password.length<6){ alert("Password must be 6+ chars"); return; }
  const usersRef = collection(db,"users");
  const q=query(usersRef,where("email","==",identifier));
  const snapshot=await getDocs(q);
  if(!snapshot.empty){return alert("User already exists");}
  const docRef = await addDoc(usersRef,{email:identifier,password:password,createdAt:Date.now(), status:"Paid"});
  currentUser={id:docRef.id,email:identifier, status:"Paid"};
  saveCurrentUser();
  watchUserStatus();
  alert("Account created & logged in");
  updateAuthUI();
  closeModal('authModal');
}

signInBtn.onclick = ()=>loginUser(authIdentifier.value.trim(),authPassword.value);
registerBtn.onclick = ()=>registerUser(authIdentifier.value.trim(),authPassword.value);
openAuthBtn.onclick=()=>openAuthModal();
guestLoginBtn.onclick=()=>openAuthModal();
logoutBtn.onclick=()=>{ currentUser=null; saveCurrentUser(); updateAuthUI(); };

/* Modals */
function openAuthModal(){authModal.style.display='flex';}
function closeModal(id){document.getElementById(id).style.display='none'; if(episodeUnsub) episodeUnsub();}
document.querySelectorAll('.modal .close').forEach(btn=>{ btn.onclick = ()=>btn.closest('.modal').style.display='none'; });

/* Update UI */
function updateAuthUI(){
  if(currentUser){ openAuthBtn.style.display='none'; logoutBtn.style.display='inline-block'; }
  else{ openAuthBtn.style.display='inline-block'; logoutBtn.style.display='none'; }
}

/* Watchlist */
function updateWatchlistCount(){
  document.getElementById("watchlistToggle").innerText=`Watchlist (${watchlist.length})`;
}
function addToWatchlistByFiltered(index){
  const movie=currentFiltered[index];
  if(!watchlist.some(m=>m.id===movie.id)) watchlist.push(movie);
  localStorage.setItem("watchlist",JSON.stringify(watchlist));
  updateWatchlistCount();
  alert(`${movie.title} added to Watchlist`);
}
document.getElementById("watchlistToggle").onclick=()=>{ renderWatchlist(); document.getElementById("watchlistModal").style.display='flex'; };
function renderWatchlist(){
  const container=document.getElementById("watchlistContainer");
  container.innerHTML="";
  watchlist.forEach((m,i)=>{
    const card=document.createElement("div");
    card.className="watchlist-card";
    card.innerHTML=`<img src="${m.poster||''}"><div>${m.title}</div><button class="remove-btn" onclick="removeFromWatchlist(${i})">Remove</button>`;
    container.appendChild(card);
  });
}
window.removeFromWatchlist=function(i){watchlist.splice(i,1);localStorage.setItem("watchlist",JSON.stringify(watchlist));updateWatchlistCount();renderWatchlist();}

/* Search & filters */
document.getElementById("search").oninput=renderMovies;
genreFilter.onchange=renderMovies;
yearFilter.onchange=renderMovies;
document.getElementById("typeFilter").onchange=renderMovies;

/* Theme */
document.getElementById("themeSelector").onchange=function(){document.body.className='theme-'+this.value;}

/* Page init */
loadCurrentUser();
updateAuthUI();
updateWatchlistCount();

/* ---------------- MODAL & YOUTUBE ---------------- */
function convertYouTubeLink(url) {
  try {
    if (url.includes("youtube.com/watch?v="))
      return `https://www.youtube.com/embed/${url.split("v=")[1].split("&")[0]}?rel=0`;
    if (url.includes("youtu.be/"))
      return `https://www.youtube.com/embed/${url.split("youtu.be/")[1].split("?")[0]}?rel=0`;
    return url;
  } catch {
    return url;
  }
}

function isDownloadable(url) {
  return /\.(mp4|mkv|mov|wmv|avi|flv|webm)$/i.test(url);
}

/* ---------------- Episodes fetching ---------------- */
let episodeUnsub = null;

async function fetchEpisodesForMovie(movieId) {
  const episodesColl = collection(db, "movies", movieId, "episodes");
  const snapshot = await getDocs(episodesColl);
  return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
}

function watchEpisodes(movieId) {
  const episodesColl = collection(db, "movies", movieId, "episodes");
  const q = query(episodesColl);
  return onSnapshot(q, snapshot => {
    const episodes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    const episodeList = document.getElementById("episodeList");
    episodeList.innerHTML = `<h4>Episodes</h4><div class="episode-list"></div>`;
    const epContainer = episodeList.querySelector(".episode-list");

    episodes.forEach(ep => {
      const epUrl = ep.fileUrl || ep.url;
      const playable = isDownloadable(epUrl);

      const epDiv = document.createElement("div");
      epDiv.style = "border:1px solid #333;padding:10px;margin-top:8px;border-radius:6px;";
      epDiv.innerHTML = `<strong>Episode ${ep.epNumber || ""}: ${ep.title || ""}</strong>
                         ${ep.description ? `<br><small>${ep.description}</small>` : ""}`;

      epDiv.addEventListener("click", () => {
        const player = document.getElementById("modalPlayer");

        // Remove previous episode video wrapper
        const existing = player.querySelector(".episode-video-wrapper");
        if (existing) existing.remove();

        const wrapper = document.createElement("div");
        wrapper.className = "episode-video-wrapper";
        wrapper.style = "margin-top:10px;position:relative;width:100%;max-height:400px;background:#000;";

        if (playable) {
          wrapper.innerHTML = `
            <button class="play-btn" style="
              position:absolute;top:50%;left:50%;
              transform:translate(-50%,-50%);
              padding:10px 15px;font-size:16px;
              border:none;border-radius:6px;
              background:#00ff66;cursor:pointer;font-weight:bold;
            ">â–¶ Play Episode</button>
            <a href="${epUrl}" download style="
              display:inline-block;margin-top:8px;
              background:#00ff66;padding:8px 12px;
              border-radius:6px;color:black;
              font-weight:bold;text-decoration:none;
            ">â¬‡ Download Episode</a>
          `;
          wrapper.querySelector(".play-btn").addEventListener("click", (e) => {
            e.target.parentElement.innerHTML = `<video controls autoplay src="${epUrl}" style="width:100%;max-height:400px;"></video>`;
          });
        } else {
          wrapper.innerHTML = `<iframe src="${epUrl}" frameborder="0" allowfullscreen style="width:100%;height:400px;"></iframe>`;
        }

        player.appendChild(wrapper);
      });

      epContainer.appendChild(epDiv);
    });
  });
}


/* ---------------- VIEW DETAILS ---------------- */
window.viewDetailsByFiltered = async function (index) {
  const m = window.currentFiltered[index];

  if(currentUser && currentUser.status !== "Paid"){
    alert("âš  Your account is unpaid. Upgrade to Paid to watch or download.");
    return;
  }

  const player = document.getElementById("modalPlayer");
  const episodeList = document.getElementById("episodeList");
  player.innerHTML = "";
  episodeList.innerHTML = "";

  // Trailer
  if (m.trailer) {
    player.innerHTML += `
      <h4>Trailer</h4>
      <iframe src="${convertYouTubeLink(m.trailer)}"
              frameborder="0" allowfullscreen
              style="width:100%;height:400px;"></iframe>
    `;
  }

  // Movie Player
  if (m.fileUrl) {
    const direct = isDownloadable(m.fileUrl);

    if (direct) {
      player.innerHTML += `
        <h4>Movie</h4>
        <video controls src="${m.fileUrl}" style="width:100%;max-height:500px;"></video>
        <a href="${m.fileUrl}" download
          style="display:inline-block;margin-top:10px;background:#00ff66;
                 padding:10px 15px;border-radius:6px;color:black;font-weight:bold;text-decoration:none;">
          â¬‡ Download
        </a>
      `;
    } else {
      player.innerHTML += `
        <h4>Movie</h4>
        <iframe src="${m.fileUrl}" frameborder="0" allowfullscreen
                style="width:100%;height:500px;"></iframe>
      `;
    }
  }

  // Episodes
  if(m.type === "Series"){
    if(episodeUnsub) episodeUnsub();
    episodeUnsub = watchEpisodes(m.id);
  }

  document.getElementById("modalTitle").innerText = m.title;
  document.getElementById("modalYear").innerText = "Year: " + m.year;
  document.getElementById("modalGenres").innerText = "Genres: " + (m.genres || []).join(", ");
  document.getElementById("modalRating").innerText = m.rating
    ? `${m.rating.toFixed(1)} / 10 (${Math.round(m.rating * 10)}%)`
    : "";
  document.getElementById("modalDesc").innerText = m.description || "";
  document.getElementById("movieModal").style.display = "flex";
  document.getElementById("modalAddToList").onclick = () => addToWatchlistByFiltered(index);
};

/* ---------------- WATCH BUTTON (with real-time episodes) ---------------- */
window.viewAndPlayByFiltered = function(index){
  const m = window.currentFiltered[index];

  // CHECK PAYMENT
  if(currentUser && currentUser.status !== "Paid"){
    alert("âš  Your account is unpaid. Upgrade to Paid to watch or download.");
    return;
  }

  const player = document.getElementById("modalPlayer");
  const episodeList = document.getElementById("episodeList");

  player.innerHTML = "";
  episodeList.innerHTML = "";

  /* ---------------- TRAILER ---------------- */
  if (m.trailer) {
    player.innerHTML += `
      <h4>Trailer</h4>
      <iframe src="${convertYouTubeLink(m.trailer)}"
              frameborder="0" allowfullscreen
              style="width:100%;height:400px;"></iframe>
    `;
  }

  /* ---------------- MOVIE / MAIN FILE ---------------- */
  if (m.fileUrl) {
    const direct = isDownloadable(m.fileUrl);

    if (direct) {
      player.innerHTML += `
        <h4>Movie</h4>
        <video controls autoplay src="${m.fileUrl}" 
               style="width:100%;max-height:500px;"></video>
        <a href="${m.fileUrl}" download
           style="display:inline-block;margin-top:10px;background:#00ff66;
                  padding:10px 15px;border-radius:6px;color:black;font-weight:bold;text-decoration:none;">
           â¬‡ Download
        </a>
      `;
    } else {
      player.innerHTML += `
        <h4>Movie</h4>
        <iframe src="${m.fileUrl}" frameborder="0" allowfullscreen
                style="width:100%;height:500px;"></iframe>
      `;
    }
  }

  /* ---------------- REAL-TIME EPISODES LIKE DETAILS ---------------- */
  if (m.type === "Series") {
    if (episodeUnsub) episodeUnsub();   // stop old listener
    episodeUnsub = watchEpisodes(m.id); // start new live listener
  }

  /* ---------------- POPULATE MODAL DATA ---------------- */
  document.getElementById("modalTitle").innerText = m.title;
  document.getElementById("modalYear").innerText = "Year: " + m.year;
  document.getElementById("modalGenres").innerText = "Genres: " + (m.genres || []).join(", ");
  document.getElementById("modalRating").innerText = m.rating
    ? `${m.rating.toFixed(1)} / 10 (${Math.round(m.rating * 10)}%)`
    : "";
  document.getElementById("modalDesc").innerText = m.description || "";

  document.getElementById("movieModal").style.display = "flex";
  document.getElementById("modalAddToList").onclick = () => addToWatchlistByFiltered(index);
};
// ---------------- BACK BUTTON HANDLING ----------------
(function() {
  const modalIds = ["movieModal", "watchlistModal"];
  let openModal = null;

  // Listen for modal openings
  const observer = new MutationObserver(() => {
    modalIds.forEach(id => {
      const modal = document.getElementById(id);
      if (modal.style.display === "flex") {
        openModal = modal;
        // Push state only if a modal opens
        history.pushState({ modalOpen: true, modalId: id }, "");
      }
    });
  });
  observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ["style"] });

  // Handle back button
  window.addEventListener("popstate", function(event) {
    if (event.state && event.state.modalOpen && event.state.modalId) {
      const modal = document.getElementById(event.state.modalId);
      if (modal) {
        modal.style.display = "none";
        openModal = null;
      }
    } else if (openModal) {
      // Close currently open modal
      openModal.style.display = "none";
      openModal = null;
      // Push a new state so user can go back to previous page if desired
      history.pushState({}, "");
    }
    // If no modal is open, back button works normally
  });
})();

</script>




</body>
</html>

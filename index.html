<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="img/logo.png" type="image/png">
<title>MovieDrift</title>
<style>
:root { --bg:#000; --card-bg:#0a0a0a; --accent:#00ff66; --text:#ddd; --muted:#888; }
body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); }
header { display:flex; justify-content:space-between; align-items:center; background:#111; padding:10px 20px; flex-wrap:wrap; }
.logo { font-size:24px; font-weight:bold; color: var(--accent); }
.controls { display:flex; gap:10px; flex-wrap:wrap; }
input, select, button, textarea { padding:6px 10px; border:1px solid var(--accent); border-radius:4px; background: var(--card-bg); color: var(--text); }
button { cursor:pointer; font-weight:bold; } button:hover { background:#003300; }
main { padding:20px; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:20px; }
.card { background: var(--card-bg); border:1px solid rgba(0,255,102,0.15); border-radius:8px; overflow:hidden; display:flex; flex-direction:column; transition: transform 0.2s; }
.card:hover { transform: scale(1.05); }
.poster { width:100%; height:300px; object-fit:cover; }
.card-body { padding:10px; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between; }
.movie-title { font-size:16px; font-weight:bold; color:var(--accent); margin:0; }
.meta { font-size:13px; color:var(--muted); margin:4px 0; }
.card-actions { display:flex; gap:5px; flex-wrap:wrap; }
.btn { flex:1; text-align:center; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; overflow-y:auto; }
.modal-content { background:var(--card-bg); max-width:900px; width:95%; max-height:90vh; overflow-y:auto; border-radius:8px; padding:20px; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; color:var(--accent); font-size:22px; }
iframe, video { width:100%; height:400px; border-radius:6px; }
#adminPanel { display:none; padding:20px; background:var(--card-bg); border-top:1px solid rgba(0,255,102,0.15); }
#adminPanel h3 { color:var(--accent); margin-bottom:10px; }
.form-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:15px; }
label { font-size:13px; color:var(--muted); margin-bottom:3px; display:block; }
.form-control { display:flex; flex-direction:column; }
textarea { resize:vertical; min-height:80px; }
.submit-row { margin-top:15px; text-align:right; }
#watchlistModal h2 { color:var(--accent); margin-bottom:15px; }
#watchlistModal .movie-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:15px; }
.watchlist-card { background:#111; border-radius:8px; padding:10px; text-align:center; transition:transform 0.2s; }
.watchlist-card:hover { transform:scale(1.05); background:#181818; }
.watchlist-card img { width:100%; border-radius:6px; margin-bottom:6px; }
.remove-btn { margin-top:6px; padding:4px 8px; border:none; border-radius:4px; background:#e63946; color:white; cursor:pointer; font-size:0.8rem; }
.remove-btn:hover { background:#c82333; }
.episode-list { margin-top:10px; }
.episode-list button { margin:2px; font-size:0.8rem; }
#uploadProgress { width:100%; background:#222; border-radius:6px; margin-top:10px; display:none; }
#uploadProgressBar { width:0%; height:20px; background:var(--accent); border-radius:6px; text-align:center; font-size:12px; color:#000; }
</style>
</head>
<body>
<header>
  <div class="logo">MovieDrift</div>
  <div class="controls">
    <input id="search" type="search" placeholder="Search movies...">
    <select id="genreFilter"><option value="">All genres</option></select>
    <select id="yearFilter"><option value="">All years</option></select>
    <button id="watchlistToggle">Watchlist (0)</button>
    <button id="adminLogin">Admin Login</button>
  </div>
</header>

<main><div id="grid" class="grid"></div></main>

<section id="adminPanel">
  <h3>➕ Add/Edit Movie</h3>
  <div class="form-grid">
    <div class="form-control"><label>Title</label><input id="movieTitle" type="text"></div>
    <div class="form-control"><label>Year</label><input id="movieYear" type="number"></div>
    <div class="form-control"><label>Genres (comma separated)</label><input id="movieGenres" type="text"></div>
    <div class="form-control"><label>Poster Image</label><input id="moviePosterFile" type="file" accept="image/*"></div>
    <div class="form-control"><label>Poster URL (optional)</label><input id="moviePosterURL" type="url"></div>
    <div class="form-control"><label>Movie File (MP4)</label><input id="movieFile" type="file" accept="video/mp4"></div>
    <div class="form-control"><label>Trailer/Embed Link (YouTube)</label><input id="movieTrailer" type="url"></div>
    <div class="form-control"><label>Episodes (MP4, select multiple)</label><input id="seriesEpisodes" type="file" accept="video/mp4" multiple></div>
    <div class="form-control" style="grid-column: span 2;">
      <label>Description</label><textarea id="movieDesc"></textarea>
    </div>
  </div>
  <div id="uploadProgress"><div id="uploadProgressBar">0%</div></div>
  <div class="submit-row"><button id="addMovieBtn">Add Movie/Series</button></div>
  <h3>📋 Manage Movies</h3>
  <div id="adminMovieList"></div>
</section>

<div class="modal" id="movieModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('movieModal')">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalYear"></p>
    <p id="modalGenres"></p>
    <div id="modalPlayer"></div>
    <div class="episode-list" id="episodeList"></div>
    <p id="modalDesc"></p>
    <button id="modalAddToList" class="btn">➕ Add to Watchlist</button>
  </div>
</div>

<div class="modal" id="watchlistModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('watchlistModal')">&times;</span>
    <h2>📺 Your Watchlist</h2>
    <div class="movie-list" id="watchlistContainer"></div>
  </div>
</div>

<script>
let movies = [];
let watchlist = JSON.parse(localStorage.getItem("watchlist")) || [];
const ADMIN_PASSWORD = "@Stone001";

document.getElementById("watchlistToggle").addEventListener("click", showWatchlist);
document.getElementById("adminLogin").addEventListener("click", () => {
  const pwd = prompt("Enter admin password:");
  if (pwd === ADMIN_PASSWORD) {
    document.getElementById("adminPanel").style.display = "block";
    loadMovies();
  } else alert("❌ Wrong password");
});

// ✅ FIXED uploader
function uploadFileWithProgress(file, type) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "upload_handler.php"); // 🔑 OPEN before send()

    const form = new FormData();
    form.append("file", file);
    form.append("type", type);

    const progressBar = document.getElementById("uploadProgressBar");
    document.getElementById("uploadProgress").style.display = "block";

    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percent + "%";
        progressBar.textContent = percent + "%";
      }
    };

    xhr.onload = () => {
      if (xhr.status === 200) {
        try {
          const res = JSON.parse(xhr.responseText);
          if (res.status === "success") resolve(res.url);
          else reject(res.message);
        } catch { reject("Invalid response"); }
      } else reject("Upload failed");
    };

    xhr.onerror = () => reject("XHR error");
    xhr.send(form); // ✅ send() after open()
  });
}

async function loadMovies() {
  try {
    const res = await fetch("movies.json");
    movies = await res.json();
    renderMovies();
    renderAdminMovies();
  } catch { movies = []; }
}

async function saveMovies() {
  await fetch("save_movies.php", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(movies)
  });
}

function renderMovies() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  movies.forEach((m,i) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<img class="poster" src="${m.poster}" alt="${m.title}">
      <div class="card-body"><h3 class="movie-title">${m.title}</h3>
      <div class="meta">${m.year} · ${m.genres.join(", ")}</div>
      <div class="card-actions">
        <button class="btn" onclick="viewDetails(${i})">Details</button>
        <button class="btn" onclick="addToWatchlist(${i})">Add to List</button>
      </div></div>`;
    grid.appendChild(card);
  });
}

function renderAdminMovies() {
  const list = document.getElementById("adminMovieList");
  list.innerHTML = "";
  movies.forEach((m,i) => {
    const div = document.createElement("div");
    div.className = "watchlist-card";
    div.innerHTML = `<h4>${m.title} (${m.year})</h4>
      <button class="remove-btn" onclick="deleteMovie(${i})">Delete</button>`;
    list.appendChild(div);
  });
}

async function deleteMovie(i) {
  if (!confirm("Delete this movie?")) return;
  movies.splice(i,1);
  await saveMovies();
  renderMovies(); renderAdminMovies();
}

document.getElementById("addMovieBtn").addEventListener("click", async () => {
  try {
    const title = movieTitle.value.trim();
    const year = movieYear.value.trim();
    const genres = movieGenres.value.split(",").map(g=>g.trim()).filter(Boolean);
    const desc = movieDesc.value.trim();

    let poster = moviePosterURL.value.trim();
    if (!poster && moviePosterFile.files[0])
      poster = await uploadFileWithProgress(moviePosterFile.files[0],"poster");

    let fileId = "";
    if (movieFile.files[0])
      fileId = await uploadFileWithProgress(movieFile.files[0],"movie");

    let trailer = convertYouTubeLink(movieTrailer.value.trim());

    let episodeIds = [];
    for (let f of seriesEpisodes.files)
      episodeIds.push(await uploadFileWithProgress(f,"episode"));

    movies.push({title,year,genres,description:desc,poster,fileId,trailer,episodeIds});
    await saveMovies();
    renderMovies(); renderAdminMovies();
    alert("✅ Movie added!");
  } catch (e) { alert("Error: "+e); }
});

function convertYouTubeLink(url) {
  if(url.includes("watch?v=")) return "https://www.youtube.com/embed/" + url.split("v=")[1].split("&")[0];
  if(url.includes("youtu.be/")) return "https://www.youtube.com/embed/" + url.split("youtu.be/")[1].split("?")[0];
  return url;
}

function viewDetails(i) {
  const m = movies[i];
  modalTitle.textContent = m.title;
  modalYear.textContent = "Year: "+m.year;
  modalGenres.textContent = "Genres: "+m.genres.join(", ");
  modalDesc.textContent = m.description || "";
  const player = modalPlayer, epList = episodeList;
  player.innerHTML = ""; epList.innerHTML = "";

  if (m.fileId) player.innerHTML = `<video controls src="${m.fileId}" autoplay></video>`;
  else if (m.trailer) player.innerHTML = `<iframe src="${m.trailer}" frameborder="0" allowfullscreen></iframe>`;
  else player.innerHTML = "<p>No video available</p>";

  if (m.episodeIds?.length) {
    m.episodeIds.forEach((ep,idx) => {
      const b=document.createElement("button");
      b.textContent="Episode "+(idx+1);
      b.onclick=()=>{player.innerHTML=`<video controls src="${ep}" autoplay></video>`};
      epList.appendChild(b);
    });
  }
  movieModal.style.display="flex";
  modalAddToList.onclick=()=>addToWatchlist(i);
}

function addToWatchlist(i) {
  if (!watchlist.find(m=>m.title===movies[i].title)) {
    watchlist.push(movies[i]); saveWatchlist();
    alert("✅ Added to Watchlist");
  } else alert("⚠️ Already in Watchlist");
  updateWatchlistButton();
}

function showWatchlist() {
  const c=watchlistContainer; c.innerHTML="";
  if (!watchlist.length) c.innerHTML="<p>No movies yet.</p>";
  else watchlist.forEach((m,i)=>{
    const d=document.createElement("div"); d.className="watchlist-card";
    d.innerHTML=`<img src="${m.poster}" alt="${m.title}">
    <h4>${m.title}</h4><p>${m.year}</p>
    <button class="remove-btn" onclick="removeFromWatchlist(${i})">Remove</button>`;
    c.appendChild(d);
  });
  watchlistModal.style.display="flex";
}

function removeFromWatchlist(i) {
  watchlist.splice(i,1); saveWatchlist();
  showWatchlist(); updateWatchlistButton();
}

function saveWatchlist(){ localStorage.setItem("watchlist",JSON.stringify(watchlist)); }
function updateWatchlistButton(){ watchlistToggle.textContent=`Watchlist (${watchlist.length})`; }
updateWatchlistButton();

function closeModal(id){ document.getElementById(id).style.display="none"; }
</script>
</body>
</html>
